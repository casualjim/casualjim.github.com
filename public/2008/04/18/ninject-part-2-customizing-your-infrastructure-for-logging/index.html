
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ninject (Part 2): Customizing your infrastructure for logging - Ivan Porto Carrero</title>
  <meta name="author" content="Ivan Porto Carrero">

  
  <meta name="description" content="Yesterday we had a little introduction to Ninject. Today I&#8217;d like to examine what&#8217;s involved in getting some AOP style logging going for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://flanders.co.nz/2008/04/18/ninject-part-2-customizing-your-infrastructure-for-logging">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ivan Porto Carrero" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-240612-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ivan Porto Carrero</a></h1>
  
    <h2>IO(thoughts) foreach (_.propagandize)</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:flanders.co.nz" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Ninject (Part 2): Customizing Your Infrastructure for Logging</h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-18T11:09:18+02:00" pubdate data-updated="true">Apr 18<span>th</span>, 2008</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Yesterday we had a little introduction to <a href="http://ninject.org">Ninject</a>. Today I&#8217;d like to examine what&#8217;s involved in getting some <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">AOP</a> style logging going for your application. I find that there are only very few places where I&#8217;m logging something that steps out of the bounds of being called at the end of the method when things succeed. I&#8217;m generally more interested in what happens when things go wrong and that&#8217;s when I log the exception. In some cases I&#8217;ll be interested in the actual parameters.</p>

<p>The code I&#8217;m going to show you will take care of basic logging needs but if you want more information about what happens inside your method you&#8217;re either going to need to extend my implementation or log the call from within your method body. We&#8217;re going to implement logging that when run with the debug level turned on will tell us that a method is going to execute, whether it finished successfully or with an error and if there was an error it will also log the exception.</p>

<p>To get this thing on the road, on the <a href="http://mindscape.co.nz">LightSpeed</a> road that is. We&#8217;re going to use <a href="http://nlog-project.com">NLog</a> to get flexible routing of log messages. We&#8217;re first going to create a LightSpeedTarget that is a customized NLog target (route destination) for your log messages.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">LoggingDemo.UI.Integration</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>    <span class="c1">/// This class represents a NLog target that we can reference in the NLog.config file</span>
</span><span class='line'>    <span class="c1">/// You can use this to use Lightspeed to log to the database just like a file target etc.</span>
</span><span class='line'>    <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'><span class="na">    [Target(&quot;LightSpeedTarget&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">LightSpeedTarget</span> <span class="p">:</span> <span class="n">TargetWithLayout</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="nf">LightSpeedTarget</span><span class="p">(){</span>
</span><span class='line'>            <span class="n">Layout</span> <span class="p">=</span> <span class="s">&quot;${message}&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Write</span><span class="p">(</span><span class="n">LogEventInfo</span> <span class="n">logEvent</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">var</span> <span class="n">logMessage</span> <span class="p">=</span> <span class="n">CompiledLayout</span><span class="p">.</span><span class="n">GetFormattedMessage</span><span class="p">(</span><span class="n">logEvent</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">var</span> <span class="n">appEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ApplicationEvent</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">Sequence</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">SequenceID</span><span class="p">,</span>
</span><span class='line'>                <span class="n">EventTime</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">TimeStamp</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Level</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">Level</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
</span><span class='line'>                <span class="n">LoggerName</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">LoggerName</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Message</span> <span class="p">=</span> <span class="n">logMessage</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">logEvent</span><span class="p">.</span><span class="n">Exception</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">appEvent</span><span class="p">.</span><span class="n">Exception</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">logEvent</span><span class="p">.</span><span class="n">StackTrace</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">appEvent</span><span class="p">.</span><span class="n">StackTrace</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">logEvent</span><span class="p">.</span><span class="n">UserStackFrame</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">appEvent</span><span class="p">.</span><span class="n">UserStackFrame</span> <span class="p">=</span> <span class="n">logEvent</span><span class="p">.</span><span class="n">UserStackFrame</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Repository</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">appEvent</span><span class="p">);</span>
</span><span class='line'>            <span class="n">Repository</span><span class="p">.</span><span class="n">CompleteUnitOfWork</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The class above overrides the TargetWithLayout class from the NLog project. The attribute tells NLog how to find this target. In the constructor I override the default message layout because it was a bit too verbose to my liking.</p>

<p>We then override the Write method where we map the properties to our ApplicationEvent. And lastly we add the event to the repository and commit it.
Now if we want our application to use this we&#8217;re going to have to tell it how. Nlog does this by looking for an nlog.config file in your application directory. So let&#8217;s go ahead and add an nlog.config file to our project. I&#8217;ll show you the nlog.config file for the application. In my unit test project I&#8217;m using the console logger so I can see what&#8217;s going on :)</p>

<p>The NLog.config file for the application:</p>

<p><img src="http://flanders.co.nz/wp-content/uploads/2008/04/image.png" alt="image" /></p>

<p>My NLog.config file for my test project:</p>

<p><img src="http://flanders.co.nz/wp-content/uploads/2008/04/image1.png" alt="image" /></p>

<p>This enables our application to use the target we just created. Moving on now to the Interceptor which is Ninject specific (You can do the same with other DI frameworks). In Ninject you can tell the kernel to intercept a method on a class and execute some logic before and after invocation of the method. We can tell Ninject to intercept all methods on a class, specific methods or when we say all methods we can still exclude some of them. For our logging example I chose to use all methods on a class. You can do this by decorating the class with an [Intercept] attribute. If you would want a method not to be intercepted you can by decorating that method with an [DoNotIntercept] attribute.</p>

<p>I took the liberty of inheriting of that attribute first.. that makes the rest of my code look a little bit prettier.</p>

<p>The LogMyCallsAttribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">Ninject.Core</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">LoggingDemo.UI.Interceptors</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">LogMyCallsAttribute</span> <span class="p">:</span> <span class="n">InterceptAttribute</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="nf">LogMyCallsAttribute</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LoggingInterceptor</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The LoggingInterceptor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Ninject.Core.Interception</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Ninject.Core.Logging</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">LoggingDemo.UI.Interceptors</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">LoggingInterceptor</span> <span class="p">:</span> <span class="n">SimpleFailureInterceptor</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_logger</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="kt">bool</span> <span class="n">_hasError</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="nf">LoggingInterceptor</span><span class="p">(</span><span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
</span><span class='line'>            <span class="n">_hasError</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">BeforeInvoke</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">_logger</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;About to invoke {0}&quot;</span><span class="p">,</span> <span class="n">MethodNameFor</span><span class="p">(</span><span class="n">invocation</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnError</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">_logger</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="s">&quot;There was an error invoking {0}.\r\n&quot;</span><span class="p">,</span> <span class="n">MethodNameFor</span><span class="p">(</span><span class="n">invocation</span><span class="p">));</span>
</span><span class='line'>            <span class="n">_hasError</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>            <span class="k">base</span><span class="p">.</span><span class="n">OnError</span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span> <span class="n">exception</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">AfterInvoke</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">_logger</span><span class="p">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;invocation of {0} finished {1}.&quot;</span><span class="p">,</span> <span class="n">MethodNameFor</span><span class="p">(</span><span class="n">invocation</span><span class="p">),</span> <span class="p">(</span><span class="n">_hasError</span> <span class="p">?</span> <span class="s">&quot;with an error state&quot;</span> <span class="p">:</span> <span class="s">&quot;successfully&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">MethodNameFor</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class only overrides a couple of callbacks from its base class the <code>SimpleFailureInterceptor</code>. This is where the actual interception takes place.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Ninject.Core</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Ninject.Core.Interception</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">LoggingDemo.UI.Interceptors</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">SimpleFailureInterceptor</span> <span class="p">:</span> <span class="n">IInterceptor</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="cp">#region IInterceptor Members</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Intercept</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">try</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">BeforeInvoke</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
</span><span class='line'>                <span class="n">invocation</span><span class="p">.</span><span class="n">Proceed</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">OnError</span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">finally</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">AfterInvoke</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cp">#endregion</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">BeforeInvoke</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">AfterInvoke</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">OnError</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">exception</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is al the work that is involved in the actual implementation of our logger. Now I&#8217;d like to get some confirmation that things actually do work. Unit testing to the rescue I&#8217;d say ;)</p>

<p>The first thing we&#8217;re going to need is way to verify that stuff actually got intercepted. I did that by subclassing the LoggingInterceptor with a LoggingCounterInterceptor in my unit test project.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">LoggingCounterInterceptor</span> <span class="p">:</span> <span class="n">LoggingInterceptor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">ErrorCount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Reset</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Count</span> <span class="p">=</span> <span class="n">ErrorCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">LoggingCounterInterceptor</span><span class="p">(</span><span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">BeforeInvoke</span><span class="p">(</span><span class="n">Ninject</span><span class="p">.</span><span class="n">Core</span><span class="p">.</span><span class="n">Interception</span><span class="p">.</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Count</span><span class="p">++;</span>
</span><span class='line'>        <span class="k">base</span><span class="p">.</span><span class="n">BeforeInvoke</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnError</span><span class="p">(</span><span class="n">Ninject</span><span class="p">.</span><span class="n">Core</span><span class="p">.</span><span class="n">Interception</span><span class="p">.</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">ErrorCount</span><span class="p">++;</span>
</span><span class='line'>        <span class="k">base</span><span class="p">.</span><span class="n">OnError</span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span> <span class="n">exception</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//The attribute for testing</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">LogMyCallsCounterAttribute</span> <span class="p">:</span> <span class="n">InterceptAttribute</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">LogMyCallsCounterAttribute</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LoggingCounterInterceptor</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the code above we&#8217;re just adding 2 counter properties to the interceptor and adding their counts at the appropriate time. Next we&#8217;re going to need some kind of service class or something on which we can use our interceptor, enter the InterceptedServiceMock.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IInterceptedServiceMock</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">void</span> <span class="nf">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>    <span class="k">void</span> <span class="nf">MethodThatThrowsAnException</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">[LogMyCallsCounter]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">InterceptedServiceMock</span> <span class="p">:</span> <span class="n">IInterceptedServiceMock</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">MethodWithoutBody</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Nothing to do here</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">MethodThatThrowsAnException</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Because I can.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code above has one method that should execute and one method that throws an exception so we can verify things get picked up accordingly. Now all that&#8217;s left to do is write the appropriate specs for them and see if they pass :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Context(Description = &quot;Specifies the behavior for the LogMyCallsInterceptor&quot;)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">LogMyCallsInterceptorSpec</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">IKernel</span> <span class="n">_kernel</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [BeforeEach]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Before</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">inlineModule</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InlineModule</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">IInterceptedServiceMock</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">InterceptedServiceMock</span><span class="p">&gt;());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">_kernel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardKernel</span><span class="p">(</span><span class="k">new</span> <span class="n">LinFuModule</span><span class="p">(),</span> <span class="k">new</span> <span class="n">NLogModule</span><span class="p">(),</span> <span class="n">inlineModule</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [AfterEach]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">After</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_kernel</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Specification(&quot;All this should do is show the calls in the test runner. It should log to the console&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldShowCallsInConsole</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">service</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IInterceptedServiceMock</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="n">IContext</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardContext</span><span class="p">(</span><span class="n">_kernel</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IInterceptedServiceMock</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IRequest</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardRequest</span><span class="p">(</span>
</span><span class='line'>            <span class="n">context</span><span class="p">,</span>
</span><span class='line'>            <span class="n">service</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="n">InterceptedServiceMock</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&quot;MethodWithoutBody&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">interceptors</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">IInterceptorRegistry</span><span class="p">&gt;().</span><span class="n">GetInterceptors</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">interceptors</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>        <span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptors</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 interceptor registered&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LoggingCounterInterceptor</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">interceptor</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span> <span class="k">as</span> <span class="n">LoggingCounterInterceptor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Not</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">Null</span><span class="p">();</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 invocation counted.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Specification(&quot;Should show valid counts for a number of invocations&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_Show_Correct_Counts_For_Number_Of_Invocations</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">service</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IInterceptedServiceMock</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="n">IContext</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardContext</span><span class="p">(</span><span class="n">_kernel</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IInterceptedServiceMock</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IRequest</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardRequest</span><span class="p">(</span>
</span><span class='line'>            <span class="n">context</span><span class="p">,</span>
</span><span class='line'>            <span class="n">service</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="n">InterceptedServiceMock</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&quot;MethodWithoutBody&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">interceptors</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">IInterceptorRegistry</span><span class="p">&gt;().</span><span class="n">GetInterceptors</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">interceptors</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>        <span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptors</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 interceptor registered&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LoggingCounterInterceptor</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">interceptor</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span> <span class="k">as</span> <span class="n">LoggingCounterInterceptor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Not</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">Null</span><span class="p">();</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="s">&quot;There should be 3 invocations counted.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">.</span><span class="n">ErrorCount</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">&quot;There should be no errors counted.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Specification(&quot;Should have the correct count of invocations and the correct error count.&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_Have_Correct_Invocation_And_Error_Count</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">service</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IInterceptedServiceMock</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardContext</span><span class="p">(</span><span class="n">_kernel</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IInterceptedServiceMock</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardRequest</span><span class="p">(</span>
</span><span class='line'>            <span class="n">context</span><span class="p">,</span>
</span><span class='line'>            <span class="n">service</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="n">InterceptedServiceMock</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&quot;MethodWithoutBody&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">errorRequest</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardRequest</span><span class="p">(</span>
</span><span class='line'>            <span class="n">context</span><span class="p">,</span>
</span><span class='line'>            <span class="n">service</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typeof</span> <span class="p">(</span><span class="n">InterceptedServiceMock</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&quot;MethodThatThrowsAnException&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">interceptors</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">IInterceptorRegistry</span><span class="p">&gt;().</span><span class="n">GetInterceptors</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">errorInterceptors</span> <span class="p">=</span> <span class="n">_kernel</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">IInterceptorRegistry</span><span class="p">&gt;().</span><span class="n">GetInterceptors</span><span class="p">(</span><span class="n">errorRequest</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">interceptors</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>        <span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">errorEnumerator</span> <span class="p">=</span> <span class="n">errorInterceptors</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>        <span class="n">errorEnumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptors</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 interceptor registered&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LoggingCounterInterceptor</span><span class="p">));</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">errorInterceptors</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 error interceptor registered&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">errorEnumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">LoggingCounterInterceptor</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">interceptor</span> <span class="p">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span> <span class="k">as</span> <span class="n">LoggingCounterInterceptor</span><span class="p">;</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">errorInterceptor</span> <span class="p">=</span> <span class="n">errorEnumerator</span><span class="p">.</span><span class="n">Current</span> <span class="k">as</span> <span class="n">LoggingCounterInterceptor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">MethodWithoutBody</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">service</span><span class="p">.</span><span class="n">MethodThatThrowsAnException</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Not</span><span class="p">.</span><span class="n">Be</span><span class="p">.</span><span class="n">Null</span><span class="p">();</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">interceptor</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="s">&quot;There should be 3 invocations counted.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">errorInterceptor</span><span class="p">.</span><span class="n">Count</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 invocation counted.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Specify</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">errorInterceptor</span><span class="p">.</span><span class="n">ErrorCount</span><span class="p">).</span><span class="n">Must</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;There should be 1 error counted.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Testing this got a little messy I have to admit that. Now for a concrete example of how that looks in my application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Service(typeof(IBlogService))]</span>
</span><span class='line'><span class="na">[LogMyCalls]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">BlogService</span> <span class="p">:</span> <span class="n">DataServiceBase</span><span class="p">&lt;</span><span class="n">Blog</span><span class="p">&gt;,</span> <span class="n">IBlogService</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&#8217;s how I implemented logging for my application :) Needless to say it was the testing that took me the longest to write. And from now on I don&#8217;t have to worry anymore about forgetting that logger call. I always have minimal logging going. AOP is usefull in a lot more cases but this seemed like a good and easy example.</p>

<p>Our next post will deal with initializing the modules in your application and their respective behaviors.</p>

<p><a href="http://www.dotnetkicks.com/kick/?url=http%3a%2f%2fflanders.co.nz%2f2008%2f04%2f18%2fninject-part-2-customizing-your-infrastructure-for-logging%2f"><img src="http://www.dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=http%3a%2f%2fflanders.co.nz%2f2008%2f04%2f18%2fninject-part-2-customizing-your-infrastructure-for-logging%2f" alt="kick it on DotNetKicks.com" /></a></p>

<p>del.icio.us Tags: <a href="http://del.icio.us/popular/LightSpeed">LightSpeed</a>,<a href="http://del.icio.us/popular/Ninject">Ninject</a>,<a href="http://del.icio.us/popular/NLog">NLog</a>,<a href="http://del.icio.us/popular/Dependency%20Injection">Dependency Injection</a>,<a href="http://del.icio.us/popular/IoC">IoC</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ivan Porto Carrero</span></span>

      








  


<time datetime="2008-04-18T11:09:18+02:00" pubdate data-updated="true">Apr 18<span>th</span>, 2008</time>
      

<span class="categories">
  
    <a class='category' href='/categories/dependency-injection/'>Dependency Injection</a>, <a class='category' href='/categories/lightspeed/'>Lightspeed</a>, <a class='category' href='/categories/ninject/'>Ninject</a>, <a class='category' href='/categories/nlog/'>Nlog</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://flanders.co.nz/2008/04/18/ninject-part-2-customizing-your-infrastructure-for-logging/" data-via="casualjim" data-counturl="http://flanders.co.nz/2008/04/18/ninject-part-2-customizing-your-infrastructure-for-logging/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2008/04/17/ninject-getting-all-the-stuff-youll-need/" title="Previous Post: Ninject: Getting all the stuff you'll need">&laquo; Ninject: Getting all the stuff you'll need</a>
      
      
        <a class="basic-alignment right" href="/2008/04/23/taking-ninject-to-new-places/" title="Next Post: Taking Ninject to new places">Taking Ninject to new places &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/09/03/scalatra-is-a-dsl-in-a-string/">Scalatra is a DSL in a string</a>
      </li>
    
      <li class="post">
        <a href="/2011/08/01/backchat-developers/">work for backchat</a>
      </li>
    
      <li class="post">
        <a href="/2010/09/30/radical-language-and-platform-shift/">Radical language and platform shift</a>
      </li>
    
      <li class="post">
        <a href="/2010/03/12/video-of-fosdem-ironruby-presentation/">Video of FOSDEM IronRuby presentation</a>
      </li>
    
      <li class="post">
        <a href="/2009/12/01/adding-a-console-to-your-ironruby-application/">Adding a console to your IronRuby application</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/casualjim">@casualjim</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'casualjim',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("casualjim", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/casualjim" class="twitter-follow-button" data-show-count="false">Follow @casualjim</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/casualjim?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/casualjim">My Delicious Bookmarks &raquo;</a></p>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/106536131996809745163?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Ivan Porto Carrero -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'casualjim';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://flanders.co.nz/2008/04/18/ninject-part-2-customizing-your-infrastructure-for-logging/';
        var disqus_url = 'http://flanders.co.nz/2008/04/18/ninject-part-2-customizing-your-infrastructure-for-logging/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
