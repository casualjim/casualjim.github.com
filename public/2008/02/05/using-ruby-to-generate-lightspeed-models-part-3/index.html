
<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

  <meta charset="utf-8">
  <title>Using Ruby to Generate LightSpeed Models - Part 3 - Ivan Porto Carrero</title>
  <meta name="author" content="Ivan Porto Carrero">

  
  <meta name="description" content="Search form Recent Posts work for backchat Radical language and platform shift Video of FOSDEM IronRuby presentation Adding a console to your &hellip;">
  

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- http://t.co/dKP3o1e -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <link rel="canonical" href="http://flanders.co.nz/2008/02/05/using-ruby-to-generate-lightspeed-models-part-3">
  <link href="/favicon.png" rel="icon">
  <link href="/css/base.css" rel="stylesheet" type="text/css">
  <link href="/css/skeleton.css" rel="stylesheet" type="text/css">
  <link href="/css/syntax.css" rel="stylesheet" type="text/css">
  <link href="/css/style.css" rel="stylesheet" type="text/css">
  <link href="/css/skins/blue.css" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">

  <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>  
  <script src="/js/modernizr.js" type="text/javascript"></script>
  <script src="/js/jquery.easing.1.3.js" type="text/javascript"></script>
  <script type="text/javascript" src="/js/jquery.illuminate.0.7.min.js"></script>
  <!-- tweet
  <script type="text/javascript" src="/js/tweet/twitter.js"></script>
  <script type="text/javascript" src="/js/tweet/setting.js"></script> -->
  
  <script type="text/javascript" src="/js/custom.js"></script>
  <link href="/atom.xml" rel="alternate" title="Ivan Porto Carrero" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-240612-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <div id="wrapper">
    <header role="banner"> <div class="container">
    <div class="row clearfix">
      <hdgroup>
        <div class="four columns">
          <div class="logo">
            <img src="/images/logo.png" alt="" />
            <h2>Rants &amp; ramblings</h2>
          </div>  
        </div>
      </hdgroup>
      <nav role="navigation"><!-- <ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:flanders.co.nz" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
   -->
<ul>
  <li>
    <a href="/">Home
      <span>Homepage</span>
    </a>    
  </li>
  <li>
    <a href="/archives">Archives
      <span>Articles</span>
    </a>    
  </li>
  <li>
    <a href="/projects">Projects
      <span>Open-Source</span>
    </a>    
  </li>
  <li>
    <a href="/about">About me
      <span>Introduction</span>
    </a>    
  </li>
</ul>
</nav>

    </div>
  </div>  
<!-- <hgroup>
  <h1><a href="/">Ivan Porto Carrero</a></h1>
  
    <h2>IO(thoughts) foreach (_.propagandize)</h2>
  
</hgroup>
 -->
</header>
    <div class="container bodycontent">
      <div class="row clearfix">
        <div class="sixteen columns headline">
          <h2>Ivan Porto Carrero</h2>
          <p class="italic">IO(thoughts) foreach (_.propagandize)</p>
        </div>
      </div>  

      <div class="sixteen columns">
        <div class="divider row"></div>
      </div>  
      
      <!-- start of row -->
      <div class="row clearfix">
        <div class="sixteen columns">
          <!-- twitter feed -->
          <div class="twitter_feed">
            <ul class="tweet_list"></ul>
          </div>
        </div>
      </div>  
      <div class="sixteen columns">
        <div class="divider row"></div>
      </div>  
      
      <div id="maincontent" class="clearfix">
        <div class="five columns">  
  <aside class="left-sidebar">
    
        
<div class="widget row">
  <h5>Search form</h5>  
  <div id="search-form">
    <form action="http://google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:flanders.co.nz" />
        <input id="search-box" type="text" name="q" results="0" placeholder="Search"/>
        <input type="submit" value="Search" id="search-button" />
        <div class="clear"></div>
      </fieldset>
    </form>
  </div>
</div>
   <section>
  <div class="widget row">
    <h5>Recent Posts</h5>  
    <ul id="recent_posts">
      
        <li class="post">
          <a href="/2011/08/01/backchat-developers/">work for backchat</a>
        </li>
      
        <li class="post">
          <a href="/2010/09/30/radical-language-and-platform-shift/">Radical language and platform shift</a>
        </li>
      
        <li class="post">
          <a href="/2010/03/12/video-of-fosdem-ironruby-presentation/">Video of FOSDEM IronRuby presentation</a>
        </li>
      
        <li class="post">
          <a href="/2009/12/01/adding-a-console-to-your-ironruby-application/">Adding a console to your IronRuby application</a>
        </li>
      
        <li class="post">
          <a href="/2009/11/08/a-good-url-regular-expression-repost/">A good url regular expression? (repost)</a>
        </li>
      
    </ul>
  </div>
</section>

<section>
  <div class="widget row">
    <h5>GitHub Repos</h5>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
    
    <a href="https://github.com/casualjim">@casualjim</a> on GitHub
    
  </div>
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = 'javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'casualjim',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"></script>
</section>


<section>
  <div class="widget row">
    <h5>Latest Tweets</h5>
    <ul id="tweets">
      <li class="loading">Status updating...</li>
    </ul>
    <script type="text/javascript">
      $(document).ready(function(){
        // getTwitterFeed("casualjim", 4, false);
      });
    </script>
    
      <a href="http://twitter.com/casualjim" class="twitter-follow-button" data-show-count="false">Follow @casualjim</a>
    
  </div>
</section>


<section>
  <div class="widget row">
    <h5>On Delicious</h5>
    <div id="delicious"></div>
    <script type="text/javascript" src="http://feeds.delicious.com/v2/json/casualjim?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
    <p><a href="http://delicious.com/casualjim">My Delicious Bookmarks &raquo;</a></p>
  </div>
</section>


<section class="googleplus">
  <div class="widget row">
    <h5>
      <a href="https://plus.google.com/106536131996809745163?rel=author">
        <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h5>
  </div>
</section>



    
  </aside>
</div>
<div class="eleven columns">
  <section id="content">
    <article class="blogpost row" role="article"> 
      
      
  <div class="post-heading"> 
    



    <p class="date">05</p>  
    <div class="month-year"><p><span>Feb</span><br />2008</p></div>



    
      <div class="post-title">
        <h5>
          <a href="" title="">Using Ruby to Generate LightSpeed Models - Part 3</a>
        </h5>
      </div> 
    
    <div class="clear"></div>
  </div>
  <!-- end of post heading -->
  
  <!-- start of post meta -->
  <div class="post-meta">
    <p>
       
  

<span class="byline author vcard">Posted by <span class="fn">Ivan Porto Carrero</span></span>

       
     </p>  
  </div>
  <!-- end of post meta -->
  


<div class="entry-content"><p>First off I&#8217;m writing with windows live writer again, ecto wasn&#8217;t up to the job. It tried to &#8220;clean&#8221; my html, granted it was messy but it should leave my text untouched. The whole editing experience wasn&#8217;t satisfying enough. And Ecto already seemed like the best blog editor for mac, slim pickings indeed. From my tools I expect foremost that they stay out of my way and it didn&#8217;t. I just talked with <a href="http://codeclimber.net.nz">Simone</a> about looking at making a .NET based client that runs on mono, we&#8217;ll see where that plan goes because I don&#8217;t really have time to do that for the moment.</p>

<p>In the previous posts in this series (<a href="http://flanders.co.nz/blog/archive/2008/02/05/using-ruby-to-generate-lightspeed-models---part-1.aspx">part 1</a>, <a href="http://flanders.co.nz/blog/archive/2008/02/05/using-ruby-to-generate-lightspeed-models.aspx">part 2</a>) we discovered how to connect to the database and how to get the meta data about that database out. Maybe I should also explain why I&#8217;m doing this series with <a href="http://www.mindscape.co.nz/Products/lightspeed/default.aspx">LightSpeed</a> instead of <a href="http://castleproject.org/activerecord/index.html">ActiveRecord</a> from <a href="http://castleproject.org/">Castle</a> or <a href="http://www.subsonicproject.com/">SubSonic</a> or Linq2Sql for that matter. I will definitely touch on all those orms in the coming week, but I started with LightSpeed because it&#8217;s the easiest ORM I&#8217;ve ever used.</p>

<p>This post will deal with actually doing something useful with that meta data. Today we&#8217;re going to generate the represenation of the entities and their properties. Tomorrow we&#8217;ll deal with actually generating the files from the the in-memory presentation we&#8217;re generating today.</p>

<p>We&#8217;re going to need 2 classes in addition to the LightSpeedRepository class. One to represent an entity and one to represent a property. The goal is for tomorrow to render the entities as complete as possible with validation attributes etc.</p>

<p>And without further ado here are the specs we&#8217;re going to build:</p>

<pre><code>LightSpeedRepository Conversion      
- should convert a given table to light speed metadata       
- should convert a given table without relations to a light speed entity definition       
- should convert a given table with a m:1 relation to a light speed entity definition       
- should convert a given table with a 1:m relation to a light speed entity definition       
- should convert a given table with a m:n relation to a light speed entity definition 



LightSpeedProperty      
- should allow for a property to be set       
- should return a predicate for booleans       
- should return a predicate for booleans       
- should return a sql type       
- should be a lightSpeed property 



LightSpeedEntity      
- should have properties, has many, belongs to and through associations       
- should create a valid property name if one doesn't exists already in the through association properties       
- should create a valid property name if one doesn't exists already in the has many properties       
- should create a valid property name if one doesn't exists already in the belongs to properties       
- should create a valid property name if one doesn't exists already in the properties       
- should create a valid property name if one already exists in the through association properties       
- should create a valid property name if one already exists in the has many properties       
- should create a valid property name if one already exists in the belongs to properties       
- should create a valid property name if one already exists in the properties       
- should create a valid property name if two already exist in the through association properties       
- should create a valid property name if two already exist in the has many properties       
- should create a valid property name if two already exist in the belongs to properties       
- should create a valid property name if two already exist in the properties
</code></pre>

<p>Let&#8217;s start with looking at the LightSpeedProperty first. The attributes on this class are implemented using some simple <a href="http://en.wikipedia.org/wiki/Metaprogramming">metaprogramming</a>. This class will represent a field in a LightSpeed entity and will take care of rendering that properly into the c# file. We actually create the data in the LightSpeedRepository class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">LightSpeedProperty</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:attributes</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="vi">@attributes</span> <span class="o">=</span> <span class="n">params</span>
</span><span class='line'>    <span class="no">LightSpeedProperty</span><span class="o">.</span><span class="n">create_methods</span> <span class="n">params</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span><span class='line'>    <span class="n">attributes</span><span class="o">[</span><span class="n">attribute</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_methods</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">params</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@attributes</span><span class="o">[</span><span class="n">k</span><span class="o">]=</span> <span class="n">val</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">predicate</span> <span class="o">=</span> <span class="sx">%w(primary_key foreign_key unique nullable)</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">o</span><span class="o">|</span> <span class="n">o</span> <span class="o">===</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">define_method</span><span class="p">(</span><span class="n">predicate</span> <span class="p">?</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">?&quot;</span> <span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>        <span class="vi">@attributes</span><span class="o">[</span><span class="n">k</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the LightSpeed entity class we describe the actual Entity. I monkey patched Array so that I could ask it the question if it has a particular property. To avoid naming conflicts we check for properties that exist already and otherwise give them a generic new name by appending a number.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Array</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">has_property?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">exists</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">hm</span><span class="o">|</span>
</span><span class='line'>      <span class="n">exists</span> <span class="o">=</span> <span class="n">hm</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">==</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">break</span> <span class="k">if</span> <span class="n">exists</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">exists</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">LightSpeedEntity</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:properties</span><span class="p">,</span> <span class="ss">:belongs_to</span><span class="p">,</span> <span class="ss">:has_many</span><span class="p">,</span> <span class="ss">:through_associations</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:namespace</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@properties</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@belongs_to</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@has_many</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@through_associations</span> <span class="o">=[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_property_name_from</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tname</span> <span class="o">=</span> <span class="n">build_property_name_from</span> <span class="n">from</span><span class="p">,</span> <span class="n">idx</span>
</span><span class='line'>    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1">#when the property exists try with a higher number</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">create_property_name_from</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_property?</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>
</span><span class='line'>    <span class="n">tname</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">has_property?</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>
</span><span class='line'>      <span class="n">properties</span><span class="o">.</span><span class="n">has_property?</span> <span class="n">tname</span> <span class="ow">or</span> <span class="n">has_many</span><span class="o">.</span><span class="n">has_property?</span> <span class="n">tname</span> <span class="ow">or</span> <span class="n">belongs_to</span><span class="o">.</span><span class="n">has_property?</span> <span class="n">tname</span> <span class="ow">or</span> <span class="n">through_associations</span><span class="o">.</span><span class="n">has_property?</span> <span class="n">tname</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">build_property_name_from</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="n">from</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">from</span><span class="si">}#{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this brings us to our last class of today the Repository class. We mixin the DB::MetaData module we created yesterday. Define a read_only property entities, make sure we can set a namespace for our generated entities. The first step is to transform the meta data into data that we can use to represent a LightSpeed Entity. The second and last step of today is to generate the entities with the lightspeed meta data. We have to skip the primary key because that is defined by convention in LightSpeed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">LightSpeedRepository</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="no">DB</span><span class="o">::</span><span class="no">MetaData</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:entities</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:namespace</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">()</span>
</span><span class='line'>    <span class="vi">@entities</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_light_speed_meta_data</span>
</span><span class='line'>    <span class="n">tables</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
</span><span class='line'>      <span class="n">col_infos</span> <span class="o">=</span> <span class="n">column_info_for</span> <span class="n">table</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">field_infos</span> <span class="o">=</span> <span class="n">col_infos</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">col_info</span><span class="o">|</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">col_info</span><span class="o">[</span><span class="ss">:name</span><span class="o">].</span><span class="n">underscore</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:sql_type</span> <span class="o">=&gt;</span> <span class="n">col_info</span><span class="o">[</span><span class="ss">:sql_type</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:max_length</span> <span class="o">=&gt;</span> <span class="n">col_info</span><span class="o">[</span><span class="ss">:max_length</span><span class="o">].</span><span class="n">to_i</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:nullable</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="n">col_info</span><span class="o">[</span><span class="ss">:is_nullable</span><span class="o">].</span><span class="n">to_i</span><span class="o">.</span><span class="n">zero?</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:precision</span> <span class="o">=&gt;</span> <span class="n">col_info</span><span class="o">[</span><span class="ss">:precision</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="n">foreign_key?</span><span class="p">(</span><span class="n">col_info</span><span class="p">),</span>
</span><span class='line'>          <span class="ss">:primary_key</span> <span class="o">=&gt;</span> <span class="n">primary_key?</span><span class="p">(</span><span class="n">col_info</span><span class="p">),</span>
</span><span class='line'>          <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="n">col_info</span><span class="o">[</span><span class="ss">:is_unique</span><span class="o">].</span><span class="n">to_i</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">{</span> <span class="ss">:table_name</span> <span class="o">=&gt;</span> <span class="n">table</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="n">table</span><span class="o">[</span><span class="ss">:name</span><span class="o">].</span><span class="n">singularize</span><span class="o">.</span><span class="n">camelize</span><span class="p">,</span> <span class="ss">:fields</span> <span class="o">=&gt;</span> <span class="n">field_infos</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">generate_entities</span>
</span><span class='line'>    <span class="n">meta_data</span> <span class="o">=</span> <span class="n">to_light_speed_meta_data</span>
</span><span class='line'>    <span class="n">meta_data</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">md</span><span class="o">|</span>
</span><span class='line'>      <span class="vi">@entities</span> <span class="o">&lt;&lt;</span> <span class="n">generate_entity</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@entities</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">generate_entity</span><span class="p">(</span><span class="n">meta_data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">entity</span> <span class="o">=</span> <span class="no">LightSpeedEntity</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">entity</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">meta_data</span><span class="o">[</span><span class="ss">:class_name</span><span class="o">]</span>
</span><span class='line'>    <span class="n">entity</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">meta_data</span><span class="o">[</span><span class="ss">:fields</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">fi</span><span class="o">|</span>
</span><span class='line'>      <span class="n">prop</span> <span class="o">=</span> <span class="no">LightSpeedProperty</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">create_property_name_from</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">underscore</span><span class="o">.</span><span class="n">camelize</span>
</span><span class='line'>      <span class="n">entity</span><span class="o">.</span><span class="n">properties</span> <span class="o">&lt;&lt;</span> <span class="n">prop</span> <span class="k">unless</span> <span class="n">prop</span><span class="o">.</span><span class="n">primary_key?</span>
</span><span class='line'>      <span class="n">entity</span><span class="o">.</span><span class="n">belongs_to</span> <span class="o">&lt;&lt;</span> <span class="n">generate_belongs_to_relation</span><span class="p">(</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">foreign_key?</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">entity</span><span class="o">.</span><span class="n">has_many</span> <span class="o">=</span> <span class="n">generate_has_many_relations</span> <span class="n">meta_data</span><span class="p">,</span> <span class="n">entity</span>
</span><span class='line'>    <span class="n">generate_through_associations</span> <span class="n">meta_data</span><span class="p">,</span> <span class="n">entity</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">entity</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">generate_belongs_to_relation</span><span class="p">(</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">field_info</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">entity</span><span class="o">.</span><span class="n">create_property_name_from</span><span class="p">(</span><span class="n">field_info</span><span class="o">[</span><span class="ss">:name</span><span class="o">].</span><span class="n">underscore</span><span class="o">.</span><span class="n">humanize</span><span class="o">.</span><span class="n">titleize</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s/</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)),</span>
</span><span class='line'>        <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="n">get_belongs_to_table</span><span class="p">(</span><span class="n">meta_data</span><span class="o">[</span><span class="ss">:table_name</span><span class="o">]</span><span class="p">,</span> <span class="n">field_info</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">underscore</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">singularize</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">generate_has_many_relations</span><span class="p">(</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
</span><span class='line'>      <span class="n">hms</span> <span class="o">=</span> <span class="n">collect_has_many_relations</span> <span class="n">meta_data</span><span class="o">[</span><span class="ss">:table_name</span><span class="o">]</span>
</span><span class='line'>      <span class="n">hms</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">hm</span><span class="o">|</span>
</span><span class='line'>         <span class="n">hm</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">create_property_name_from</span> <span class="n">hm</span><span class="o">[</span><span class="ss">:class_name</span><span class="o">].</span><span class="n">pluralize</span>
</span><span class='line'>         <span class="n">hm</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">generate_through_associations</span><span class="p">(</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
</span><span class='line'>      <span class="n">tas</span> <span class="o">=</span> <span class="n">collect_through_associations</span><span class="p">(</span><span class="n">meta_data</span><span class="o">[</span><span class="ss">:table_name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">tas</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ta</span><span class="o">|</span>
</span><span class='line'>        <span class="n">ta</span><span class="o">[</span><span class="ss">:end_tables</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">et</span><span class="o">|</span>
</span><span class='line'>          <span class="n">entity</span><span class="o">.</span><span class="n">through_associations</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="n">ta</span><span class="o">[</span><span class="ss">:through_table</span><span class="o">].</span><span class="n">classify</span><span class="o">.</span><span class="n">singularize</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="n">et</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">singularize</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">entity</span><span class="o">.</span><span class="n">create_property_name_from</span><span class="p">(</span><span class="n">et</span><span class="o">.</span><span class="n">camelize</span><span class="p">)</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>

      
      
        <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://flanders.co.nz/2008/02/05/using-ruby-to-generate-lightspeed-models-part-3/" data-via="casualjim" data-counturl="http://flanders.co.nz/2008/02/05/using-ruby-to-generate-lightspeed-models-part-3/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

            
      <p class="post-meta">
        
          <a class="basic-alignment left" href="/2008/02/05/using-ruby-to-generate-lightspeed-models/" title="Previous Post: Using Ruby to Generate LightSpeed models - Part 2">&laquo; Using Ruby to Generate LightSpeed models - Part 2</a>
        
        
          <a class="basic-alignment right" href="/2008/02/06/on-software-development-the-myth-of-no-maintenance-etc/" title="Next Post: On software development: the myth of no maintenance etc.">On software development: the myth of no maintenance etc. &raquo;</a>
        
      </p>
      
    </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


      </div>
    </div>
    <footer role="contentinfo"><!-- start of footer container -->
  <div class="container">
    <!-- start of row - 4 widget columns -->
      <div class="row clearfix">
      <div class="twelve columns">
        <div class="logo">
          <img src="/images/logo.png" alt="" />
          <h2>Rants &amp; ramblings</h2>
        </div>
      </div>

      <div class="four columns">        
        <h6>Social networks</h6>
        <ul class="social_network">
          <li class="rollover"><a href="http://facebook.com/ivanportocarrero" class="yellowtip" title="Facebook"><span class="fb-rollover"></span><img src="/images/social/fb.png" alt="" /></a></li>
          <li class="rollover"><a href="http://twitter.com/casualjim" class="yellowtip" title="Follow me"><span class="twitter-rollover"></span><img src="/images/social/twitter.png" alt="" /></a></li>
          <li class="rollover"><a href="https://plus.google.com/u/1/106536131996809745163/posts" class="yellowtip" title="Google plus"><span class="google-rollover"></span><img src="/images/social/google-plus.png" alt="" /></a></li>
        </ul>       
      </div>
    </div>
    <!-- end of row -->
  
    <!-- start of row - 4 widget columns -->
      <div class="row clearfix">
      <div class="eight columns">
        <h6>About me</h6>
        <p>
        Welcome to my blog. This is a collection of random thoughts and rants.
        </p>
        <p>
        Allow me to introduce myself. My name is Ivan Porto Carrero and I'm an enthusiastic developer on  Scala, .NET and Ruby.<br />Through this blog I hope I can share some of that passion and maybe help somebody out when they are looking on how to do something.
        </p>
      </div>
      <div class="four columns">
        <h6>Latest posts</h6>
        <ul class="square">
        
          <li>
            <a href="/2011/08/01/backchat-developers/">work for backchat</a>
          </li>
        
          <li>
            <a href="/2010/09/30/radical-language-and-platform-shift/">Radical language and platform shift</a>
          </li>
        
          <li>
            <a href="/2010/03/12/video-of-fosdem-ironruby-presentation/">Video of FOSDEM IronRuby presentation</a>
          </li>
        
          <li>
            <a href="/2009/12/01/adding-a-console-to-your-ironruby-application/">Adding a console to your IronRuby application</a>
          </li>
        
          <li>
            <a href="/2009/11/08/a-good-url-regular-expression-repost/">A good url regular expression? (repost)</a>
          </li>
        
        </ul> 
      </div>
      <div class="four columns">
        <h6>Browse pages</h6>
        <ul class="square">
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archives</a></li>
          <li><a href="/projects">My projects</a></li>
        </ul> 
      </div>
    </div>
    <!-- end of row -->
    

    <!-- start of footer divider -->
    <div class="sixteen columns">
      <div class="footer-divider row"></div>
    </div>  
    <!-- end of footer divider -->
    
    <!-- start of bottoms -->
    <div class="clearfix footnote">
      <div class="eight columns">
        <p class="copyright">Copyright &copy; 2012 - Ivan Porto Carrero - All Right Reserved</p>
      </div>
      <div class="eight columns">
        <p class="align-right"><span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, designed by <a href="http://iweb-studio.com" target="_blank">iwebstudio</a></p>
      </div>
    </div>
    <!-- end of bottoms -->

  </div>
  <!-- end of footer container -->

</footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'casualjim';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://flanders.co.nz/2008/02/05/using-ruby-to-generate-lightspeed-models-part-3/';
        var disqus_url = 'http://flanders.co.nz/2008/02/05/using-ruby-to-generate-lightspeed-models-part-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<p id="back-top">
  <a href="#top"><span></span>To top</a>
</p>

</body>
</html>
